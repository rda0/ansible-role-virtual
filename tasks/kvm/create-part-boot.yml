---
- stat:
    path: "{% set letters='cdefghijklmnopqrstuvwxyz' %}/dev/{{ (item.1.vg|default(virtual_disk_vg)) }}/{{ virtual_guest_name }}{{ item.1.mount|default('/dev/sd' + letters[item.0])|replace('/', '-') }}"
  register: guest_lvm_disks
  with_indexed_items: '{{ virtual_disks }}'
  when: virtual_disks is defined

- fail:
    msg: 'guest lvm already exists: {{ item.invocation.module_args.path }}'
  when: virtual_disks is defined and item.stat.exists is defined and item.stat.exists == True
  with_items: '{{ guest_lvm_disks.results }}'

- name: set fact mount_path
  set_fact:
    mount_path: "{{ virtual_mount_base_path }}/{{ virtual_guest_name }}_{{ 1000000 | random | hash('sha1') }}"

- name: create boot lv
  lvol:
    vg: '{{ virtual_disk_vg }}'
    lv: '{{ virtual_guest_name }}-boot'
    size: '512M'

- name: create root lv
  lvol:
    vg: '{{ virtual_disk_vg }}'
    lv: '{{ virtual_guest_name }}-root'
    size: "{{ virtual_disk_size|default('2G') }}"

- name: create disk lvs
  lvol:
    vg: '{{ (item.1.vg|default(virtual_disk_vg)) }}'
    lv: "{% set letters='cdefghijklmnopqrstuvwxyz' %}{{ virtual_guest_name }}{{ item.1.mount|default('/dev/sd' + letters[item.0])|replace('/', '-') }}"
    size: "{{ item.1.size }}"
  with_indexed_items: '{{ virtual_disks }}'
  when: virtual_disks is defined

- name: dump boot disk from template lv
  command: 'dd if=/dev/{{ virtual_template_vg }}/{{ virtual_template_name }}-{{ virtual_codename }}-boot of=/dev/{{ virtual_disk_vg }}/{{ virtual_guest_name }}-boot bs=1M'
  when: not virtual_template_type == 'file'

- name: dump boot disk from template image
  command: 'dd if={{ virtual_template_path }}/{{ virtual_template_name }}-{{ virtual_codename }}-boot of=/dev/{{ virtual_disk_vg }}/{{ virtual_guest_name }}-boot bs=1M'
  when: virtual_template_type == 'file'

- name: dump root filesystem from template lv
  command: 'dd if=/dev/{{ virtual_template_vg }}/{{ virtual_template_name }}-{{ virtual_codename }}-root of=/dev/{{ virtual_disk_vg }}/{{ virtual_guest_name }}-root bs=1M'
  when: not virtual_template_type == 'file'

- name: dump root filesystem from template image
  command: 'dd if={{ virtual_template_path }}/{{ virtual_template_name }}-{{ virtual_codename }}-root of=/dev/{{ virtual_disk_vg }}/{{ virtual_guest_name }}-root bs=1M'
  when: virtual_template_type == 'file'

- name: check root filesystem
  command: 'e2fsck -pf /dev/{{ virtual_disk_vg }}/{{ virtual_guest_name }}-root'

- name: change root filesystem uuid
  shell: 'echo y | tune2fs /dev/{{ virtual_disk_vg }}/{{ virtual_guest_name }}-root -U random'

- name: resize root filesystem
  command: 'resize2fs /dev/{{ virtual_disk_vg }}/{{ virtual_guest_name }}-root'

- name: create root mount dir
  file:
    path: '{{ mount_path }}/root'
    state: directory

- name: create disk mount dirs
  file:
    path: "{{ mount_path }}/{{ item.mount[1:]|replace('/', '-') }}"
    state: directory
  with_items: '{{ virtual_disks | selectattr("mount", "defined") | list }}'
  when: virtual_disks is defined

- name: mount root filesystem
  command: 'mount /dev/{{ virtual_disk_vg }}/{{ virtual_guest_name }}-root {{ mount_path }}/root'
  args:
    warn: false

- name: set hostname
  shell: 'echo "{{ virtual_guest_name }}" > {{ mount_path }}/root/etc/hostname'

- name: add disks to fstab
  shell: "echo '{% set letters='cdefghijklmnopqrstuvwxyz' %}/dev/sd{{ letters[item.0] }}  {{ item.1.mount }}  {{ (item.1.fs|default(virtual_disk_fs)) }} defaults          0 2' >> {{ mount_path }}/root/etc/fstab"
  with_indexed_items: '{{ virtual_disks | selectattr("mount", "defined") | list }}'
  when: virtual_disks is defined

- name: make disk filesystems
  command: "mkfs.{{ (item.fs|default(virtual_disk_fs)) }} /dev/{{ (item.vg|default(virtual_disk_vg)) }}/{{ virtual_guest_name }}{{ item.mount|replace('/', '-') }}"
  with_items: '{{ virtual_disks | selectattr("mount", "defined") | list }}'
  when: virtual_disks is defined

- name: create mount points in root filesystem
  file:
    path: "{{ mount_path }}/root{{ item.mount }}"
    state: directory
  with_items: '{{ virtual_disks | selectattr("mount", "defined") | list }}'
  when: virtual_disks is defined

- name: mount disk filesystems
  command: "mount /dev/{{ (item.vg|default(virtual_disk_vg)) }}/{{ virtual_guest_name }}{{ item.mount|replace('/', '-') }} {{ mount_path }}/{{ item.mount[1:]|replace('/', '-') }}"
  args:
    warn: false
  with_items: '{{ virtual_disks | selectattr("mount", "defined") | list }}'
  when: virtual_disks is defined

- name: move files to separate disks
  shell: "mv {{ mount_path }}/root{{ item.mount }}/* {{ mount_path }}/{{ item.mount[1:]|replace('/', '-') }}/; umount /dev/{{ (item.vg|default(virtual_disk_vg)) }}/{{ virtual_guest_name }}{{ item.mount|replace('/', '-') }}; mount /dev/{{ (item.vg|default(virtual_disk_vg)) }}/{{ virtual_guest_name }}{{ item.mount|replace('/', '-') }} {{ mount_path }}/root{{ item.mount }}"
  args:
    warn: false
  ignore_errors: yes
  with_items: '{{ virtual_disks | selectattr("mount", "defined") | list }}'
  when: virtual_disks is defined

- name: umount disk filesystems
  command: "umount /dev/{{ (item.vg|default(virtual_disk_vg)) }}/{{ virtual_guest_name }}{{ item.mount|replace('/', '-') }}"
  with_items: '{{ virtual_disks | selectattr("mount", "defined") | list | reverse | list }}'
  when: virtual_disks is defined

- name: umount root filesystem
  command: 'umount /dev/{{ virtual_disk_vg }}/{{ virtual_guest_name }}-root'

- name: remove mount dir
  file:
    path: '{{ mount_path }}'
    state: absent

- name: create vm
  command: |
    virt-install \
    --name={{ virtual_guest_name }} \
    --virt-type=kvm \
    {% if virtual_memory_hotpluggable %}
    --cpu=model=host,cell0.id=0,cell0.cpus={{ virtual_numa_cell_cpus }},cell0.memory={{ virtual_numa_cell_memory }} \
    --memory=memory={{ virtual_memory }},hotplugmemorymax={{ virtual_memory_max }},hotplugmemoryslots={{ virtual_memory_slots }} \
    {% else %}
    --cpu=host \
    --memory={{ virtual_memory }} \
    {% endif %}
    {% if virtual_cpus_hotpluggable %}
    --vcpus=vcpus={{ virtual_cpus }},maxvcpus={{ virtual_cpus_max }} \
    {% else %}
    --vcpus={{ virtual_cpus }} \
    {% endif %}
    {% if virtual_memory_hugepages %}
    --memorybacking=hugepages=yes,size={{ virtual_memory_hugepages_size }},unit={{ virtual_memory_hugepages_unit }} \
    {% endif %}
    {% if virtual_memory_balloon %}
    --memballoon=virtio \
    {% else %}
    --memballoon=none \
    {% endif %}
    --controller=type=scsi,model=virtio-scsi \
    --disk=path=/dev/{{ virtual_disk_vg }}/{{ virtual_guest_name }}-boot,bus=scsi,cache=none,address.type=drive,address.controller=0,address.bus=0,address.target=0,address.unit=0,boot_order=1 \
    --disk=path=/dev/{{ virtual_disk_vg }}/{{ virtual_guest_name }}-root,bus=scsi,cache=none,address.type=drive,address.controller=0,address.bus=0,address.target=1,address.unit=1 \
    {% set letters='cdefghijklmnopqrstuvwxyz' %}
    {% for disk in virtual_disks|default([]) %}
    --disk=path=/dev/{{ (disk.vg|default(virtual_disk_vg)) }}/{{ virtual_guest_name }}{{ disk.mount|default('/dev/sd' + letters[loop.index - 1])|replace('/', '-') }},bus=scsi,cache=none,address.type=drive,address.controller=0,address.bus=0,address.target={{ loop.index + 1 }},address.unit={{ loop.index + 1 }} \
    {% endfor %}
    --import \
    --os-type=linux \
    --os-variant={{ os_variant }} \
    --console=pty,target_type=serial \
    {% if virtual_mac is defined %}
    --network=bridge={{ virtual_bridge }},model=virtio,target={{ virtual_interface_name }},mac={{ virtual_mac }} \
    {% else %}
    --network=bridge={{ virtual_bridge }},model=virtio,target={{ virtual_interface_name }} \
    {% endif %}
    --nographics \
    --noautoconsole \
    --autostart
